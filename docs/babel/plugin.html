<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Babel 插件手册 | Zachary</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="前端学习笔记">
    
    <link rel="preload" href="/Zachary/assets/css/0.styles.c575f4e7.css" as="style"><link rel="preload" href="/Zachary/assets/js/app.0753c76b.js" as="script"><link rel="preload" href="/Zachary/assets/js/2.78341334.js" as="script"><link rel="preload" href="/Zachary/assets/js/19.71dc5316.js" as="script"><link rel="prefetch" href="/Zachary/assets/js/10.35580ba2.js"><link rel="prefetch" href="/Zachary/assets/js/11.216e76de.js"><link rel="prefetch" href="/Zachary/assets/js/12.883931d6.js"><link rel="prefetch" href="/Zachary/assets/js/13.81c66bcf.js"><link rel="prefetch" href="/Zachary/assets/js/14.0c158d85.js"><link rel="prefetch" href="/Zachary/assets/js/15.5a57096f.js"><link rel="prefetch" href="/Zachary/assets/js/16.da193788.js"><link rel="prefetch" href="/Zachary/assets/js/17.45ecf4b9.js"><link rel="prefetch" href="/Zachary/assets/js/18.ea579b1b.js"><link rel="prefetch" href="/Zachary/assets/js/20.f45d0c52.js"><link rel="prefetch" href="/Zachary/assets/js/21.be90986c.js"><link rel="prefetch" href="/Zachary/assets/js/22.3c80eb44.js"><link rel="prefetch" href="/Zachary/assets/js/23.20b583e4.js"><link rel="prefetch" href="/Zachary/assets/js/24.7661aa25.js"><link rel="prefetch" href="/Zachary/assets/js/25.9f23fe68.js"><link rel="prefetch" href="/Zachary/assets/js/26.cc8052d8.js"><link rel="prefetch" href="/Zachary/assets/js/27.d1e65e99.js"><link rel="prefetch" href="/Zachary/assets/js/28.657f8749.js"><link rel="prefetch" href="/Zachary/assets/js/29.5076149d.js"><link rel="prefetch" href="/Zachary/assets/js/3.52668d12.js"><link rel="prefetch" href="/Zachary/assets/js/30.dc74b638.js"><link rel="prefetch" href="/Zachary/assets/js/31.7ab4d111.js"><link rel="prefetch" href="/Zachary/assets/js/32.975343b7.js"><link rel="prefetch" href="/Zachary/assets/js/33.28848e32.js"><link rel="prefetch" href="/Zachary/assets/js/34.5fbd072c.js"><link rel="prefetch" href="/Zachary/assets/js/35.868c15dd.js"><link rel="prefetch" href="/Zachary/assets/js/36.4a90fbf4.js"><link rel="prefetch" href="/Zachary/assets/js/37.a16cd24d.js"><link rel="prefetch" href="/Zachary/assets/js/38.f344ae4d.js"><link rel="prefetch" href="/Zachary/assets/js/39.a4a764ee.js"><link rel="prefetch" href="/Zachary/assets/js/4.8cb9cbb2.js"><link rel="prefetch" href="/Zachary/assets/js/40.55a4b8f6.js"><link rel="prefetch" href="/Zachary/assets/js/41.fb524cf0.js"><link rel="prefetch" href="/Zachary/assets/js/42.e93c3ade.js"><link rel="prefetch" href="/Zachary/assets/js/43.bea3fdb0.js"><link rel="prefetch" href="/Zachary/assets/js/44.5900afd7.js"><link rel="prefetch" href="/Zachary/assets/js/45.f7790a0c.js"><link rel="prefetch" href="/Zachary/assets/js/46.d117b01c.js"><link rel="prefetch" href="/Zachary/assets/js/47.414b1a89.js"><link rel="prefetch" href="/Zachary/assets/js/48.7dfe07fb.js"><link rel="prefetch" href="/Zachary/assets/js/49.65da5c07.js"><link rel="prefetch" href="/Zachary/assets/js/5.cf09887d.js"><link rel="prefetch" href="/Zachary/assets/js/50.6f72cb7e.js"><link rel="prefetch" href="/Zachary/assets/js/51.5f34ed5b.js"><link rel="prefetch" href="/Zachary/assets/js/52.559c9930.js"><link rel="prefetch" href="/Zachary/assets/js/53.98b026c6.js"><link rel="prefetch" href="/Zachary/assets/js/54.ae982b1c.js"><link rel="prefetch" href="/Zachary/assets/js/55.25d3775d.js"><link rel="prefetch" href="/Zachary/assets/js/56.cc666002.js"><link rel="prefetch" href="/Zachary/assets/js/57.373dc95c.js"><link rel="prefetch" href="/Zachary/assets/js/58.40e6c5a9.js"><link rel="prefetch" href="/Zachary/assets/js/59.f3f123c3.js"><link rel="prefetch" href="/Zachary/assets/js/6.b20e554c.js"><link rel="prefetch" href="/Zachary/assets/js/60.c559ba98.js"><link rel="prefetch" href="/Zachary/assets/js/61.900de37f.js"><link rel="prefetch" href="/Zachary/assets/js/62.1484eb13.js"><link rel="prefetch" href="/Zachary/assets/js/7.99bab301.js"><link rel="prefetch" href="/Zachary/assets/js/8.f4ac18fa.js"><link rel="prefetch" href="/Zachary/assets/js/9.2b6dec57.js">
    <link rel="stylesheet" href="/Zachary/assets/css/0.styles.c575f4e7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Zachary/" class="home-link router-link-active"><img src="/Zachary/assets/img/logo.jpg" alt="Zachary" class="logo"> <span class="site-name can-hide">Zachary</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Zachary/babel/" class="nav-link router-link-active">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="babel" class="dropdown-title"><span class="title">babel</span> <span class="arrow down"></span></button> <button type="button" aria-label="babel" class="mobile-dropdown-title"><span class="title">babel</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Zachary/babel/" class="nav-link router-link-active">
  概览
</a></li><li class="dropdown-item"><!----> <a href="/Zachary/babel/integration/" class="nav-link">
  集成
</a></li><li class="dropdown-item"><!----> <a href="/Zachary/babel/presets/" class="nav-link">
  Presets
</a></li><li class="dropdown-item"><!----> <a href="/Zachary/babel/tools/" class="nav-link">
  工具
</a></li><li class="dropdown-item"><!----> <a href="/Zachary/babel/user/" class="nav-link">
  Babel 用户手册
</a></li><li class="dropdown-item"><!----> <a href="/Zachary/babel/plugin/" class="nav-link">
  Babel 插件手册
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="webpack" class="dropdown-title"><span class="title">webpack</span> <span class="arrow down"></span></button> <button type="button" aria-label="webpack" class="mobile-dropdown-title"><span class="title">webpack</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Zachary/webpack/" class="nav-link">
  概览
</a></li><li class="dropdown-item"><!----> <a href="/Zachary/webpack/source/" class="nav-link">
  原理分析
</a></li><li class="dropdown-item"><!----> <a href="/Zachary/webpack/diff2rollup/" class="nav-link">
  同中有异的Rollup
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Zachary-alt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Zachary/babel/" class="nav-link router-link-active">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="babel" class="dropdown-title"><span class="title">babel</span> <span class="arrow down"></span></button> <button type="button" aria-label="babel" class="mobile-dropdown-title"><span class="title">babel</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Zachary/babel/" class="nav-link router-link-active">
  概览
</a></li><li class="dropdown-item"><!----> <a href="/Zachary/babel/integration/" class="nav-link">
  集成
</a></li><li class="dropdown-item"><!----> <a href="/Zachary/babel/presets/" class="nav-link">
  Presets
</a></li><li class="dropdown-item"><!----> <a href="/Zachary/babel/tools/" class="nav-link">
  工具
</a></li><li class="dropdown-item"><!----> <a href="/Zachary/babel/user/" class="nav-link">
  Babel 用户手册
</a></li><li class="dropdown-item"><!----> <a href="/Zachary/babel/plugin/" class="nav-link">
  Babel 插件手册
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="webpack" class="dropdown-title"><span class="title">webpack</span> <span class="arrow down"></span></button> <button type="button" aria-label="webpack" class="mobile-dropdown-title"><span class="title">webpack</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Zachary/webpack/" class="nav-link">
  概览
</a></li><li class="dropdown-item"><!----> <a href="/Zachary/webpack/source/" class="nav-link">
  原理分析
</a></li><li class="dropdown-item"><!----> <a href="/Zachary/webpack/diff2rollup/" class="nav-link">
  同中有异的Rollup
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Zachary-alt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Babel 插件手册</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Zachary/babel/plugin.html#抽象语法树-asts" class="sidebar-link">抽象语法树（ASTs）</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Zachary/babel/plugin.html#babel-的处理步骤" class="sidebar-link">Babel 的处理步骤</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#解析" class="sidebar-link">解析</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#转换" class="sidebar-link">转换</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#生成" class="sidebar-link">生成</a></li></ul></li><li><a href="/Zachary/babel/plugin.html#遍历" class="sidebar-link">遍历</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#visitors-访问者" class="sidebar-link">Visitors（访问者）</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#paths-路径" class="sidebar-link">Paths（路径）</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#state-状态" class="sidebar-link">State（状态）</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#scopes-作用域" class="sidebar-link">Scopes（作用域）</a></li></ul></li><li><a href="/Zachary/babel/plugin.html#babylon" class="sidebar-link">babylon</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Zachary/babel/plugin.html#babel-traverse" class="sidebar-link">babel-traverse</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Zachary/babel/plugin.html#babel-types" class="sidebar-link">babel-types</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#definitions-定义" class="sidebar-link">Definitions（定义）</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#builders-构建器" class="sidebar-link">Builders（构建器）</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#validators-验证器" class="sidebar-link">Validators（验证器）</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#converters-变换器" class="sidebar-link">Converters（变换器）</a></li></ul></li><li><a href="/Zachary/babel/plugin.html#babel-generator" class="sidebar-link">babel-generator</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Zachary/babel/plugin.html#babel-template" class="sidebar-link">babel-template</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Zachary/babel/plugin.html#访问" class="sidebar-link">访问</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#获取子节点的path" class="sidebar-link">获取子节点的Path</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#检查节点的类型" class="sidebar-link">检查节点的类型</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#检查路径-path-类型" class="sidebar-link">检查路径（Path）类型</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#检查标识符-identifier-是否被引用" class="sidebar-link">检查标识符（Identifier）是否被引用</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#找到特定的父路径" class="sidebar-link">找到特定的父路径</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#获取同级路径" class="sidebar-link">获取同级路径</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#停止遍历" class="sidebar-link">停止遍历</a></li></ul></li><li><a href="/Zachary/babel/plugin.html#处理" class="sidebar-link">处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#替换一个节点" class="sidebar-link">替换一个节点</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#用多节点替换单节点" class="sidebar-link">用多节点替换单节点</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#用字符串源码替换节点" class="sidebar-link">用字符串源码替换节点</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#插入兄弟节点" class="sidebar-link">插入兄弟节点</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#插入到容器-container-中" class="sidebar-link">插入到容器（container）中</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#删除一个节点" class="sidebar-link">删除一个节点</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#替换父节点" class="sidebar-link">替换父节点</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#删除父节点" class="sidebar-link">删除父节点</a></li></ul></li><li><a href="/Zachary/babel/plugin.html#scope-作用域" class="sidebar-link">Scope（作用域）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#检查本地变量是否被绑定" class="sidebar-link">检查本地变量是否被绑定</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#创建一个-uid" class="sidebar-link">创建一个 UID</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#提升变量声明至父级作用域" class="sidebar-link">提升变量声明至父级作用域</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#重命名绑定及其引用" class="sidebar-link">重命名绑定及其引用</a></li></ul></li><li><a href="/Zachary/babel/plugin.html#插件的准备和收尾工作" class="sidebar-link">插件的准备和收尾工作</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Zachary/babel/plugin.html#在插件中启用其他语法" class="sidebar-link">在插件中启用其他语法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Zachary/babel/plugin.html#抛出一个语法错误" class="sidebar-link">抛出一个语法错误</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Zachary/babel/plugin.html#create-helper-builders-and-checkers" class="sidebar-link">Create Helper Builders and Checkers</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Zachary/babel/plugin.html#尽量避免遍历抽象语法树-ast" class="sidebar-link">尽量避免遍历抽象语法树（AST）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#及时合并访问者对象" class="sidebar-link">及时合并访问者对象</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#可以手动查找就不要遍历" class="sidebar-link">可以手动查找就不要遍历</a></li></ul></li><li><a href="/Zachary/babel/plugin.html#优化嵌套的访问者对象" class="sidebar-link">优化嵌套的访问者对象</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Zachary/babel/plugin.html#留意嵌套结构" class="sidebar-link">留意嵌套结构</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Zachary/babel/plugin.html#单元测试" class="sidebar-link">单元测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#快照测试" class="sidebar-link">快照测试</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#exec-tests" class="sidebar-link">Exec Tests</a></li><li class="sidebar-sub-header"><a href="/Zachary/babel/plugin.html#babel-plugin-tester" class="sidebar-link">babel-plugin-tester</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="babel-插件手册"><a href="#babel-插件手册" class="header-anchor">#</a> Babel 插件手册</h1> <p>这篇文档涵盖了如何创建 <a href="https://babeljs.io" target="_blank" rel="noopener noreferrer">Babel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://babeljs.io/docs/advanced/plugins/" target="_blank" rel="noopener noreferrer">插件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>等方面的内容。.</p> <p><a href="http://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener noreferrer"><img src="https://licensebuttons.net/l/by/4.0/80x15.png" alt="cc-by-4.0"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>这本手册提供了多种语言的版本，查看 <a href="/Zachary/" class="router-link-active">自述文件</a> 里的完整列表。</p> <h1 id="目录"><a href="#目录" class="header-anchor">#</a> 目录</h1> <ul><li><a href="#toc-introduction">介绍</a></li> <li><a href="#toc-basics">基础</a> <ul><li><a href="#toc-asts">抽象语法树（ASTs）</a></li> <li><a href="#toc-stages-of-babel">Babel 的处理步骤</a></li> <li><a href="#toc-parse">解析</a> <ul><li><a href="#toc-lexical-analysis">词法分析</a></li> <li><a href="#toc-syntactic-analysis">语法分析</a></li></ul></li> <li><a href="#toc-transform">转换</a></li> <li><a href="#toc-generate">生成</a></li> <li><a href="#toc-traversal">遍历</a></li> <li><a href="#toc-visitors">Visitors（访问者）</a></li> <li><a href="#toc-paths">Paths（路径）</a> <ul><li><a href="#toc-paths-in-visitors">Paths in Visitors（存在于访问者中的路径）</a></li></ul></li> <li><a href="#toc-state">State（状态）</a></li> <li><a href="#toc-scopes">Scopes（作用域）</a> <ul><li><a href="#toc-bindings">Bindings（绑定）</a></li></ul></li></ul></li> <li><a href="#toc-api">API</a> <ul><li><a href="#toc-babylon">babylon</a></li> <li><a href="#toc-babel-traverse">babel-traverse</a></li> <li><a href="#toc-babel-types">babel-types</a></li> <li><a href="#toc-definitions">Definitions（定义）</a></li> <li><a href="#toc-builders">Builders（构建器）</a></li> <li><a href="#toc-validators">Validators（验证器）</a></li> <li><a href="#toc-converters">Converters（变换器）</a></li> <li><a href="#toc-babel-generator">babel-generator</a></li> <li><a href="#toc-babel-template">babel-template</a></li></ul></li> <li><a href="#toc-writing-your-first-babel-plugin">编写你的第一个 Babel 插件</a></li> <li><a href="#toc-transformation-operations">转换操作</a> <ul><li><a href="#toc-visiting">访问</a></li> <li><a href="#toc-get-the-path-of-a-sub-node">获取子节点的Path</a></li> <li><a href="#toc-check-if-a-node-is-a-certain-type">检查节点（Node）类型</a></li> <li><a href="#toc-check-if-a-path-is-a-certain-type">检查路径（Path）类型</a></li> <li><a href="#toc-check-if-an-identifier-is-referenced">检查标识符（Identifier）是否被引用</a></li> <li><a href="#toc-find-a-specific-parent-path">找到特定的父路径</a></li> <li><a href="#toc-get-sibling-paths">获取同级路径</a></li> <li><a href="#toc-stopping-traversal">停止遍历</a></li> <li><a href="#toc-manipulation">处理</a></li> <li><a href="#toc-replacing-a-node">替换一个节点</a></li> <li><a href="#toc-replacing-a-node-with-multiple-nodes">用多节点替换单节点</a></li> <li><a href="#toc-replacing-a-node-with-a-source-string">用字符串源码替换节点</a></li> <li><a href="#toc-inserting-a-sibling-node">插入兄弟节点</a></li> <li><a href="#toc-inserting-into-a-container">插入到容器（container）中</a></li> <li><a href="#toc-removing-a-node">删除节点</a></li> <li><a href="#toc-replacing-a-parent">替换父节点</a></li> <li><a href="#toc-removing-a-parent">删除父节点</a></li> <li><a href="#toc-scope">Scope（作用域）</a></li> <li><a href="#toc-checking-if-a-local-variable-is-bound">检查本地变量是否被绑定</a></li> <li><a href="#toc-generating-a-uid">生成UID</a></li> <li><a href="#toc-pushing-a-variable-declaration-to-a-parent-scope">提升变量声明至父级作用域</a></li> <li><a href="#toc-rename-a-binding-and-its-references">重命名绑定及其引用</a></li></ul></li> <li><a href="#toc-plugin-options">插件选项</a> <ul><li><a href="#toc-pre-and-post-in-plugins">插件的准备和收尾工作</a></li> <li><a href="#toc-enabling-syntax-in-plugins">在插件中启用其他语法</a></li></ul></li> <li><a href="#toc-building-nodes">构建节点</a></li> <li><a href="#toc-best-practices">最佳实践</a> <ul><li><a href="#toc-avoid-traversing-the-ast-as-much-as-possible">尽量避免遍历抽象语法树（AST）</a></li> <li><a href="#toc-merge-visitors-whenever-possible">及时合并访问者对象</a></li> <li><a href="#toc-do-not-traverse-when-manual-lookup-will-do">可以手动查找就不要遍历</a></li> <li><a href="#toc-optimizing-nested-visitors">优化嵌套的访问者对象</a></li> <li><a href="#toc-being-aware-of-nested-structures">留意嵌套结构</a></li> <li><a href="#toc-unit-testing">单元测试</a></li></ul></li></ul> <h1 id="介绍"><a href="#介绍" class="header-anchor">#</a> <a id="toc-introduction"></a>介绍</h1> <p>Babel 是一个通用的多功能的 JavaScript 编译器。此外它还拥有众多模块可用于不同形式的静态分析。</p> <blockquote><p>静态分析是在不需要执行代码的前提下对代码进行分析的处理过程 （执行代码的同时进行代码分析即是动态分析）。 静态分析的目的是多种多样的， 它可用于语法检查，编译，代码高亮，代码转换，优化，压缩等等场景。</p></blockquote> <p>你可以使用 Babel 创建多种类型的工具来帮助你更有效率并且写出更好的程序。</p> <blockquote><p><em><strong>在 Twitter 上关注 <a href="https://twitter.com/thejameskyle" target="_blank" rel="noopener noreferrer">@thejameskyle<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，第一时间获取更新。</strong></em></p></blockquote> <hr> <h1 id="基础"><a href="#基础" class="header-anchor">#</a> <a id="toc-basics"></a>基础</h1> <p>Babel 是 JavaScript 编译器，更确切地说是源码到源码的编译器，通常也叫做“转换编译器（transpiler）”。 意思是说你为 Babel 提供一些 JavaScript 代码，Babel 更改这些代码，然后返回给你新生成的代码。</p> <h2 id="抽象语法树-asts"><a href="#抽象语法树-asts" class="header-anchor">#</a> <a id="toc-asts"></a>抽象语法树（ASTs）</h2> <p>这个处理过程中的每一步都涉及到创建或是操作<a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank" rel="noopener noreferrer">抽象语法树<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，亦称 AST。</p> <blockquote><p>Babel 使用一个基于 <a href="https://github.com/estree/estree" target="_blank" rel="noopener noreferrer">ESTree<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 并修改过的 AST，它的内核说明文档可以在[这里](https://github. com/babel/babel/blob/master/doc/ast/spec. md)找到。.</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n <span class="token operator">*</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><a href="http://astexplorer.net/" target="_blank" rel="noopener noreferrer">AST Explorer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 可以让你对 AST 节点有一个更好的感性认识。 <a href="http://astexplorer.net/#/Z1exs6BWMq" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是上述代码的一个示例链接。</p></blockquote> <p>这个程序可以被表示成如下的一棵树：</p> <div class="language-md extra-class"><pre class="language-md"><code><span class="token list punctuation">-</span> FunctionDeclaration:
  <span class="token list punctuation">-</span> id:
    <span class="token list punctuation">-</span> Identifier:
      <span class="token list punctuation">-</span> name: square
  <span class="token list punctuation">-</span> params [1]
    <span class="token list punctuation">-</span> Identifier
      <span class="token list punctuation">-</span> name: n
  <span class="token list punctuation">-</span> body:
    <span class="token list punctuation">-</span> BlockStatement
      <span class="token list punctuation">-</span> body [1]
        <span class="token list punctuation">-</span> ReturnStatement
          <span class="token list punctuation">-</span> argument
            <span class="token list punctuation">-</span> BinaryExpression
              <span class="token list punctuation">-</span> operator: *
              <span class="token list punctuation">-</span> left
                <span class="token list punctuation">-</span> Identifier
                  <span class="token list punctuation">-</span> name: n
              <span class="token list punctuation">-</span> right
                <span class="token list punctuation">-</span> Identifier
                  <span class="token list punctuation">-</span> name: n
</code></pre></div><p>或是如下所示的 JavaScript Object（对象）：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;FunctionDeclaration&quot;</span><span class="token punctuation">,</span>
  id<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;square&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  body<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;BlockStatement&quot;</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;ReturnStatement&quot;</span><span class="token punctuation">,</span>
      argument<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">&quot;BinaryExpression&quot;</span><span class="token punctuation">,</span>
        operator<span class="token operator">:</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span>
        left<span class="token operator">:</span> <span class="token punctuation">{</span>
          type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
          name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        right<span class="token operator">:</span> <span class="token punctuation">{</span>
          type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
          name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>你会留意到 AST 的每一层都拥有相同的结构：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;FunctionDeclaration&quot;</span><span class="token punctuation">,</span>
  id<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  body<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;BinaryExpression&quot;</span><span class="token punctuation">,</span>
  operator<span class="token operator">:</span> <span class="token operator">...</span><span class="token punctuation">,</span>
  left<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  right<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>注意：出于简化的目的移除了某些属性</p></blockquote> <p>这样的每一层结构也被叫做 <strong>节点（Node）</strong>。 一个 AST 可以由单一的节点或是成百上千个节点构成。 它们组合在一起可以描述用于静态分析的程序语法。</p> <p>每一个节点都有如下所示的接口（Interface）：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
  <span class="token keyword">type</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>字符串形式的 <code>type</code> 字段表示节点的类型（如： <code>&quot;FunctionDeclaration&quot;</code>，<code>&quot;Identifier&quot;</code>，或 <code>&quot;BinaryExpression&quot;</code>）。 每一种类型的节点定义了一些附加属性用来进一步描述该节点类型。</p> <p>Babel 还为每个节点额外生成了一些属性，用于描述该节点在原始代码中的位置。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token operator">...</span><span class="token punctuation">,</span>
  start<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  end<span class="token operator">:</span> <span class="token number">38</span><span class="token punctuation">,</span>
  loc<span class="token operator">:</span> <span class="token punctuation">{</span>
    start<span class="token operator">:</span> <span class="token punctuation">{</span>
      line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      column<span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    end<span class="token operator">:</span> <span class="token punctuation">{</span>
      line<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      column<span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>每一个节点都会有 <code>start</code>，<code>end</code>，<code>loc</code> 这几个属性。</p> <h2 id="babel-的处理步骤"><a href="#babel-的处理步骤" class="header-anchor">#</a> <a id="toc-stages-of-babel"></a>Babel 的处理步骤</h2> <p>Babel 的三个主要处理步骤分别是： <strong>解析（parse）</strong>，<strong>转换（transform）</strong>，<strong>生成（generate）</strong>。.</p> <h3 id="解析"><a href="#解析" class="header-anchor">#</a> <a id="toc-parse"></a>解析</h3> <p><strong>解析</strong>步骤接收代码并输出 AST。 这个步骤分为两个阶段：<a href="https://en.wikipedia.org/wiki/Lexical_analysis" target="_blank" rel="noopener noreferrer">**词法分析（Lexical Analysis） **<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和 <a href="https://en.wikipedia.org/wiki/Parsing" target="_blank" rel="noopener noreferrer"><strong>语法分析（Syntactic Analysis）</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。.</p> <h4 id="词法分析"><a href="#词法分析" class="header-anchor">#</a> <a id="toc-lexical-analysis"></a>词法分析</h4> <p>词法分析阶段把字符串形式的代码转换为 <strong>令牌（tokens）</strong> 流。.</p> <p>你可以把令牌看作是一个扁平的语法片段数组：</p> <div class="language-js extra-class"><pre class="language-js"><code>n <span class="token operator">*</span> n<span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span><span class="token punctuation">,</span> start<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> loc<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span> start<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> loc<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span><span class="token punctuation">,</span> start<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> loc<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">]</span>
</code></pre></div><p>每一个 <code>type</code> 有一组属性来描述该令牌：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token punctuation">{</span>
    label<span class="token operator">:</span> <span class="token string">'name'</span><span class="token punctuation">,</span>
    keyword<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    beforeExpr<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    startsExpr<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    rightAssociative<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    isLoop<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    isAssign<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    prefix<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    postfix<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    binop<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    updateContext<span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>和 AST 节点一样它们也有 <code>start</code>，<code>end</code>，<code>loc</code> 属性。.</p> <h4 id="语法分析"><a href="#语法分析" class="header-anchor">#</a> <a id="toc-syntactic-analysis"></a>语法分析</h4> <p>语法分析阶段会把一个令牌流转换成 AST 的形式。 这个阶段会使用令牌中的信息把它们转换成一个 AST 的表述结构，这样更易于后续的操作。</p> <h3 id="转换"><a href="#转换" class="header-anchor">#</a> <a id="toc-transform"></a>转换</h3> <p><a href="https://en.wikipedia.org/wiki/Program_transformation" target="_blank" rel="noopener noreferrer">转换<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>步骤接收 AST 并对其进行遍历，在此过程中对节点进行添加、更新及移除等操作。 这是 Babel 或是其他编译器中最复杂的过程 同时也是插件将要介入工作的部分，这将是本手册的主要内容， 因此让我们慢慢来。</p> <h3 id="生成"><a href="#生成" class="header-anchor">#</a> <a id="toc-generate"></a>生成</h3> <p><a href="https://en.wikipedia.org/wiki/Code_generation_(compiler)" target="_blank" rel="noopener noreferrer">代码生成<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>步骤把最终（经过一系列转换之后）的 AST 转换成字符串形式的代码，同时还会创建<a href="http://www.html5rocks.com/en/tutorials/developertools/sourcemaps/" target="_blank" rel="noopener noreferrer">源码映射（source maps）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。.</p> <p>代码生成其实很简单：深度优先遍历整个 AST，然后构建可以表示转换后代码的字符串。</p> <h2 id="遍历"><a href="#遍历" class="header-anchor">#</a> <a id="toc-traversal"></a>遍历</h2> <p>想要转换 AST 你需要进行递归的<a href="https://en.wikipedia.org/wiki/Tree_traversal" target="_blank" rel="noopener noreferrer">树形遍历<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>比方说我们有一个 <code>FunctionDeclaration</code> 类型。它有几个属性：<code>id</code>，<code>params</code>，和 <code>body</code>，每一个都有一些内嵌节点。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;FunctionDeclaration&quot;</span><span class="token punctuation">,</span>
  id<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;square&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  body<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;BlockStatement&quot;</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;ReturnStatement&quot;</span><span class="token punctuation">,</span>
      argument<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">&quot;BinaryExpression&quot;</span><span class="token punctuation">,</span>
        operator<span class="token operator">:</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span>
        left<span class="token operator">:</span> <span class="token punctuation">{</span>
          type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
          name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        right<span class="token operator">:</span> <span class="token punctuation">{</span>
          type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
          name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>于是我们从 <code>FunctionDeclaration</code> 开始并且我们知道它的内部属性（即：<code>id</code>，<code>params</code>，<code>body</code>），所以我们依次访问每一个属性及它们的子节点。</p> <p>接着我们来到 <code>id</code>，它是一个 <code>Identifier</code>。<code>Identifier</code> 没有任何子节点属性，所以我们继续。</p> <p>之后是 <code>params</code>，由于它是一个数组节点所以我们访问其中的每一个，它们都是 <code>Identifier</code> 类型的单一节点，然后我们继续。</p> <p>此时我们来到了 <code>body</code>，这是一个 <code>BlockStatement</code> 并且也有一个 <code>body</code>节点，而且也是一个数组节点，我们继续访问其中的每一个。</p> <p>这里唯一的一个属性是 <code>ReturnStatement</code> 节点，它有一个 <code>argument</code>，我们访问 <code>argument</code> 就找到了 <code>BinaryExpression</code>。.</p> <p><code>BinaryExpression</code> 有一个 <code>operator</code>，一个 <code>left</code>，和一个 <code>right</code>。 Operator 不是一个节点，它只是一个值因此我们不用继续向内遍历，我们只需要访问 <code>left</code> 和 <code>right</code>。.</p> <p>Babel 的转换步骤全都是这样的遍历过程。</p> <h3 id="visitors-访问者"><a href="#visitors-访问者" class="header-anchor">#</a> <a id="toc-visitors"></a>Visitors（访问者）</h3> <p>当我们谈及“进入”一个节点，实际上是说我们在<strong>访问</strong>它们， 之所以使用这样的术语是因为有一个<a href="https://en.wikipedia.org/wiki/Visitor_pattern" target="_blank" rel="noopener noreferrer"><strong>访问者模式（visitor）</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的概念。.</p> <p>访问者是一个用于 AST 遍历的跨语言的模式。 简单的说它们就是一个对象，定义了用于在一个树状结构中获取具体节点的方法。 这么说有些抽象所以让我们来看一个例子。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Called!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 你也可以先创建一个访问者对象，并在稍后给它添加方法。</span>
<span class="token keyword">let</span> visitor <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
visitor<span class="token punctuation">.</span><span class="token function-variable function">MemberExpression</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
visitor<span class="token punctuation">.</span><span class="token function-variable function">FunctionDeclaration</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><blockquote><p><strong>注意</strong>： <code>Identifier() { ... }</code> 是 <code>Identifier: { enter() { ... } }</code> 的简写形式。.</p></blockquote> <p>这是一个简单的访问者，把它用于遍历中时，每当在树中遇见一个 <code>Identifier</code> 的时候会调用 <code>Identifier()</code> 方法。</p> <p>所以在下面的代码中 <code>Identifier()</code> 方法会被调用四次（包括 <code>square</code> 在内，总共有四个 <code>Identifier</code>）。).</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n <span class="token operator">*</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>MyVisitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
Called<span class="token operator">!</span>
Called<span class="token operator">!</span>
Called<span class="token operator">!</span>
Called<span class="token operator">!</span>
</code></pre></div><p>这些调用都发生在<strong>进入</strong>节点时，不过有时候我们也可以在<strong>退出</strong>时调用访问者方法。.</p> <p>假设我们有一个树状结构：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">-</span> FunctionDeclaration
  <span class="token operator">-</span> <span class="token function">Identifier</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
  <span class="token operator">-</span> <span class="token function">Identifier</span> <span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token operator">-</span> <span class="token function">BlockStatement</span> <span class="token punctuation">(</span>body<span class="token punctuation">)</span>
    <span class="token operator">-</span> <span class="token function">ReturnStatement</span> <span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token operator">-</span> <span class="token function">BinaryExpression</span> <span class="token punctuation">(</span>argument<span class="token punctuation">)</span>
        <span class="token operator">-</span> <span class="token function">Identifier</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span>
        <span class="token operator">-</span> <span class="token function">Identifier</span> <span class="token punctuation">(</span>right<span class="token punctuation">)</span>
</code></pre></div><p>当我们向下遍历这颗树的每一个分支时我们最终会走到尽头，于是我们需要往上遍历回去从而获取到下一个节点。 向下遍历这棵树我们<strong>进入</strong>每个节点，向上遍历回去时我们<strong>退出</strong>每个节点。</p> <p>让我们以上面那棵树为例子走一遍这个过程。</p> <ul><li>进入 <code>FunctionDeclaration</code> <ul><li>进入 <code>Identifier (id)</code></li> <li>走到尽头</li> <li>退出 <code>Identifier (id)</code></li> <li>进入 <code>Identifier (params[0])</code></li> <li>走到尽头</li> <li>退出 <code>Identifier (params[0])</code></li> <li>进入 <code>BlockStatement (body)</code></li> <li>进入 <code>ReturnStatement (body)</code> <ul><li>进入 <code>BinaryExpression (argument)</code></li> <li>进入 <code>Identifier (left)</code> <ul><li>走到尽头</li></ul></li> <li>退出 <code>Identifier (left)</code></li> <li>进入 <code>Identifier (right)</code> <ul><li>走到尽头</li></ul></li> <li>退出 <code>Identifier (right)</code></li> <li>退出 <code>BinaryExpression (argument)</code></li></ul></li> <li>退出 <code>ReturnStatement (body)</code></li> <li>退出 <code>BlockStatement (body)</code></li></ul></li> <li>退出 <code>FunctionDeclaration</code></li></ul> <p>所以当创建访问者时你实际上有两次机会来访问一个节点。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  Identifier<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Entered!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Exited!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>如有必要，你还可以把方法名用<code>|</code>分割成<code>Idenfifier |MemberExpression</code>形式的字符串，把同一个函数应用到多种访问节点。.</p> <p>在<a href="https://github.com/babel/babel/blob/2b6ff53459d97218b0cf16f8a51c14a165db1fd2/packages/babel-plugin-transform-flow-comments/src/index.js#L47" target="_blank" rel="noopener noreferrer">flow-comments<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 插件中的例子如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;ExportNamedDeclaration|Flow&quot;</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>你也可以在访问者中使用别名(如<a href="https://github.com/babel/babel/tree/master/packages/babel-types/src/definitions" target="_blank" rel="noopener noreferrer">babel-types<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>定义).</p> <p>例如，</p> <p><code>Function</code> is an alias for <code>FunctionDeclaration</code>, <code>FunctionExpression</code>, <code>ArrowFunctionExpression</code>, <code>ObjectMethod</code> and <code>ClassMethod</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">Function</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="paths-路径"><a href="#paths-路径" class="header-anchor">#</a> <a id="toc-paths"></a>Paths（路径）</h3> <p>AST 通常会有许多节点，那么节点直接如何相互关联呢？ 我们可以使用一个可操作和访问的巨大可变对象表示节点之间的关联关系，或者也可以用<strong>Paths</strong>（路径）来简化这件事情。.</p> <p><strong>Path</strong> 是表示两个节点之间连接的对象。</p> <p>例如，如果有下面这样一个节点及其子节点︰</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;FunctionDeclaration&quot;</span><span class="token punctuation">,</span>
  id<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;square&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>将子节点 <code>Identifier</code> 表示为一个路径（Path）的话，看起来是这样的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;parent&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;FunctionDeclaration&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;id&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;node&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;square&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同时它还包含关于该路径的其他元数据：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;parent&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;node&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;hub&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;contexts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;shouldSkip&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">&quot;shouldStop&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">&quot;removed&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">&quot;state&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;opts&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;skipKeys&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;parentPath&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;context&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;container&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;listKey&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;inList&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">&quot;parentKey&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;key&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;typeAnnotation&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当然路径对象还包含添加、更新、移动和删除节点有关的其他很多方法，稍后我们再来看这些方法。</p> <p>在某种意义上，路径是一个节点在树中的位置以及关于该节点各种信息的响应式 <strong>Reactive</strong> 表示。 当你调用一个修改树的方法后，路径信息也会被更新。 Babel 帮你管理这一切，从而使得节点操作简单，尽可能做到无状态。</p> <h4 id="paths-in-visitors-存在于访问者中的路径"><a href="#paths-in-visitors-存在于访问者中的路径" class="header-anchor">#</a> <a id="toc-paths-in-visitors"></a>Paths in Visitors（存在于访问者中的路径）</h4> <p>当你有一个 <code>Identifier()</code> 成员方法的访问者时，你实际上是在访问路径而非节点。 通过这种方式，你操作的就是节点的响应式表示（译注：即路径）而非节点本身。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Visiting: &quot;</span> <span class="token operator">+</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>MyVisitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
Visiting<span class="token operator">:</span> a
Visiting<span class="token operator">:</span> b
Visiting<span class="token operator">:</span> c
</code></pre></div><h3 id="state-状态"><a href="#state-状态" class="header-anchor">#</a> <a id="toc-state"></a>State（状态）</h3> <p>状态是抽象语法树AST转换的敌人，状态管理会不断牵扯你的精力，而且几乎所有你对状态的假设，总是会有一些未考虑到的语法最终证明你的假设是错误的。</p> <p>考虑下列代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n <span class="token operator">*</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>让我们写一个把 <code>n</code> 重命名为 <code>x</code> 的访问者的快速实现.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> paramName<span class="token punctuation">;</span>

<span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> param <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    paramName <span class="token operator">=</span> param<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    param<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;x&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">===</span> paramName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;x&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>对上面的例子代码这段访问者代码也许能工作，但它很容易被打破：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n <span class="token operator">*</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
n<span class="token punctuation">;</span>
</code></pre></div><p>更好的处理方式是使用递归，下面让我们来像克里斯托佛·诺兰的电影盗梦空间那样来把一个访问者放进另外一个访问者里面。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> updateParamNameVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>paramName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;x&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> param <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> paramName <span class="token operator">=</span> param<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    param<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;x&quot;</span><span class="token punctuation">;</span>

    path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>updateParamNameVisitor<span class="token punctuation">,</span> <span class="token punctuation">{</span> paramName <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>MyVisitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当然，这只是一个刻意编写的例子，不过它演示了如何从访问者中消除全局状态。</p> <h3 id="scopes-作用域"><a href="#scopes-作用域" class="header-anchor">#</a> <a id="toc-scopes"></a>Scopes（作用域）</h3> <p>接下来让我们介绍<a href="https://en.wikipedia.org/wiki/Scope_(computer_science)" target="_blank" rel="noopener noreferrer"><strong>作用域（scope）</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的概念。 JavaScript 支持<a href="https://en.wikipedia.org/wiki/Scope_(computer_science)#Lexical_scoping_vs._dynamic_scoping" target="_blank" rel="noopener noreferrer">词法作用域<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，在树状嵌套结构中代码块创建出新的作用域。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// global scope</span>

<span class="token keyword">function</span> <span class="token function">scopeOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// scope 1</span>

  <span class="token keyword">function</span> <span class="token function">scopeTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// scope 2</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 JavaScript 中，每当你创建了一个引用，不管是通过变量（variable）、函数（function）、类型（class）、参数（params）、模块导入（import）还是标签（label）等，它都属于当前作用域。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> global <span class="token operator">=</span> <span class="token string">&quot;I am in the global scope&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">scopeOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> one <span class="token operator">=</span> <span class="token string">&quot;I am in the scope created by `scopeOne()`&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">scopeTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> two <span class="token operator">=</span> <span class="token string">&quot;I am in the scope created by `scopeTwo()`&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>更深的内部作用域代码可以使用外层作用域中的引用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">scopeOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> one <span class="token operator">=</span> <span class="token string">&quot;I am in the scope created by `scopeOne()`&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">scopeTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    one <span class="token operator">=</span> <span class="token string">&quot;I am updating the reference in `scopeOne` inside `scopeTwo`&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>内层作用域也可以创建和外层作用域同名的引用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">scopeOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> one <span class="token operator">=</span> <span class="token string">&quot;I am in the scope created by `scopeOne()`&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">scopeTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> one <span class="token operator">=</span> <span class="token string">&quot;I am creating a new `one` but leaving reference in `scopeOne()` alone.&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当编写一个转换时，必须小心作用域。我们得确保在改变代码的各个部分时不会破坏已经存在的代码。</p> <p>我们在添加一个新的引用时需要确保新增加的引用名字和已有的所有引用不冲突。 或者我们仅仅想找出使用一个变量的所有引用， 我们只想在给定的作用域（Scope）中找出这些引用。</p> <p>作用域可以被表示为如下形式：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  path<span class="token operator">:</span> path<span class="token punctuation">,</span>
  block<span class="token operator">:</span> path<span class="token punctuation">.</span>node<span class="token punctuation">,</span>
  parentBlock<span class="token operator">:</span> path<span class="token punctuation">.</span>parent<span class="token punctuation">,</span>
  parent<span class="token operator">:</span> parentScope<span class="token punctuation">,</span>
  bindings<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当你创建一个新的作用域时，需要给出它的路径和父作用域，之后在遍历过程中它会在该作用域内收集所有的引用(“绑定”)。</p> <p>一旦引用收集完毕，你就可以在作用域（Scopes）上使用各种方法，稍后我们会了解这些方法。</p> <h4 id="bindings-绑定"><a href="#bindings-绑定" class="header-anchor">#</a> <a id="toc-bindings"></a>Bindings（绑定）</h4> <p>所有引用属于特定的作用域，引用和作用域的这种关系被称作：<strong>绑定（binding）</strong>。.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">scopeOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> ref <span class="token operator">=</span> <span class="token string">&quot;This is a binding&quot;</span><span class="token punctuation">;</span>

  ref<span class="token punctuation">;</span> <span class="token comment">// This is a reference to a binding</span>

  <span class="token keyword">function</span> <span class="token function">scopeTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ref<span class="token punctuation">;</span> <span class="token comment">// This is a reference to a binding from a lower scope</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>单个绑定看起来像这样︰</p> <div class="language-js extra-class"><pre class="language-js"><code>Text <span class="token keyword">for</span> Translation
<span class="token punctuation">{</span>
  identifier<span class="token operator">:</span> node<span class="token punctuation">,</span>
  scope<span class="token operator">:</span> scope<span class="token punctuation">,</span>
  path<span class="token operator">:</span> path<span class="token punctuation">,</span>
  kind<span class="token operator">:</span> <span class="token string">'var'</span><span class="token punctuation">,</span>

  referenced<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  references<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  referencePaths<span class="token operator">:</span> <span class="token punctuation">[</span>path<span class="token punctuation">,</span> path<span class="token punctuation">,</span> path<span class="token punctuation">]</span><span class="token punctuation">,</span>

  constant<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  constantViolations<span class="token operator">:</span> <span class="token punctuation">[</span>path<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>有了这些信息你就可以查找一个绑定的所有引用，并且知道这是什么类型的绑定(参数，定义等等)，查找它所属的作用域，或者拷贝它的标识符。 你甚至可以知道它是不是常量，如果不是，那么是哪个路径修改了它。</p> <p>在很多情况下，知道一个绑定是否是常量非常有用，最有用的一种情形就是代码压缩时。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">scopeOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> ref1 <span class="token operator">=</span> <span class="token string">&quot;This is a constant binding&quot;</span><span class="token punctuation">;</span>

  <span class="token function">becauseNothingEverChangesTheValueOf</span><span class="token punctuation">(</span>ref1<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">scopeTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> ref2 <span class="token operator">=</span> <span class="token string">&quot;This is *not* a constant binding&quot;</span><span class="token punctuation">;</span>
    ref2 <span class="token operator">=</span> <span class="token string">&quot;Because this changes the value&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <h1 id="api"><a href="#api" class="header-anchor">#</a> <a id="toc-api"></a>API</h1> <p>Babel 实际上是一组模块的集合。本节我们将探索一些主要的模块，解释它们是做什么的以及如何使用它们。</p> <blockquote><p>注意：本节内容不是详细的 API 文档的替代品，正式的 API 文档将很快提供出来。</p></blockquote> <h2 id="babylon"><a href="#babylon" class="header-anchor">#</a> <a id="toc-babylon"></a><a href="https://github.com/babel/babylon" target="_blank" rel="noopener noreferrer"><code>babylon</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <p>Babylon 是 Babel 的解析器。最初是 从Acorn项目fork出来的。Acorn非常快，易于使用，并且针对非标准特性(以及那些未来的标准特性) 设计了一个基于插件的架构。</p> <p>首先，让我们安装它。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">npm</span> <span class="token function">install</span> --save babylon
</code></pre></div><p>先从解析一个代码字符串开始：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> babylon <span class="token keyword">from</span> <span class="token string">&quot;babylon&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function square(n) {
  return n * n;
}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

babylon<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Node {</span>
<span class="token comment">//   type: &quot;File&quot;,</span>
<span class="token comment">//   start: 0,</span>
<span class="token comment">//   end: 38,</span>
<span class="token comment">//   loc: SourceLocation {...},</span>
<span class="token comment">//   program: Node {...},</span>
<span class="token comment">//   comments: [],</span>
<span class="token comment">//   tokens: [...]</span>
<span class="token comment">// }</span>
</code></pre></div><p>我们还能像下面这样传递选项给 <code>parse()</code>方法：</p> <div class="language-js extra-class"><pre class="language-js"><code>babylon<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  sourceType<span class="token operator">:</span> <span class="token string">&quot;module&quot;</span><span class="token punctuation">,</span> <span class="token comment">// default: &quot;script&quot;</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;jsx&quot;</span><span class="token punctuation">]</span> <span class="token comment">// default: []</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>sourceType</code> 可以是 <code>&quot;module&quot;</code> 或者 <code>&quot;script&quot;</code>，它表示 Babylon 应该用哪种模式来解析。 <code>&quot;module&quot;</code> 将会在严格模式下解析并且允许模块定义，<code>&quot;script&quot;</code> 则不会。</p> <blockquote><p><strong>注意：</strong> <code>sourceType</code> 的默认值是 <code>&quot;script&quot;</code> 并且在发现 <code>import</code> 或 <code>export</code> 时产生错误。 使用 <code>scourceType: &quot;module&quot;</code> 来避免这些错误。</p></blockquote> <p>由于 Babylon 使用了基于插件的架构，因此有一个 <code>plugins</code> 选项可以开关内置的插件。 注意 Babylon 尚未对外部插件开放此 API 接口，不排除未来会开放此API。</p> <p>要查看完整的插件列表，请参见 <a href="https://github.com/babel/babylon/blob/master/README.md#plugins" target="_blank" rel="noopener noreferrer">Babylon README<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>文件。.</p> <h2 id="babel-traverse"><a href="#babel-traverse" class="header-anchor">#</a> <a id="toc-babel-traverse"></a><a href="https://github.com/babel/babel/tree/master/packages/babel-traverse" target="_blank" rel="noopener noreferrer"><code>babel-traverse</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <p>Babel Traverse（遍历）模块维护了整棵树的状态，并且负责替换、移除和添加节点。</p> <p>运行以下命令安装：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">npm</span> <span class="token function">install</span> --save babel-traverse
</code></pre></div><p>我们可以和 Babylon 一起使用来遍历和更新节点：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> babylon <span class="token keyword">from</span> <span class="token string">&quot;babylon&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> traverse <span class="token keyword">from</span> <span class="token string">&quot;babel-traverse&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function square(n) {
  return n * n;
}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ast <span class="token operator">=</span> babylon<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;Identifier&quot;</span> <span class="token operator">&amp;&amp;</span>
      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;n&quot;</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;x&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="babel-types"><a href="#babel-types" class="header-anchor">#</a> <a id="toc-babel-types"></a><a href="https://github.com/babel/babel/tree/master/packages/babel-types" target="_blank" rel="noopener noreferrer"><code>babel-types</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <p>Babel Types模块是一个用于 AST 节点的 Lodash 式工具库（译注：Lodash 是一个 JavaScript 函数工具库，提供了基于函数式编程风格的众多工具函数）， 它包含了构造、验证以及变换 AST 节点的方法。 该工具库包含考虑周到的工具方法，对编写处理AST逻辑非常有用。</p> <p>可以运行以下命令来安装它：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">npm</span> <span class="token function">install</span> --save babel-types
</code></pre></div><p>然后按如下所示来使用：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> traverse <span class="token keyword">from</span> <span class="token string">&quot;babel-traverse&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> t <span class="token keyword">from</span> <span class="token string">&quot;babel-types&quot;</span><span class="token punctuation">;</span>

<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;x&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="definitions-定义"><a href="#definitions-定义" class="header-anchor">#</a> <a id="toc-definitions"></a>Definitions（定义）</h3> <p>Babel Types模块拥有每一个单一类型节点的定义，包括节点包含哪些属性，什么是合法值，如何构建节点、遍历节点，以及节点的别名等信息。</p> <p>单一节点类型的定义形式如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">defineType</span><span class="token punctuation">(</span><span class="token string">&quot;BinaryExpression&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  builder<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;operator&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;left&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  fields<span class="token operator">:</span> <span class="token punctuation">{</span>
    operator<span class="token operator">:</span> <span class="token punctuation">{</span>
      validate<span class="token operator">:</span> <span class="token function">assertValueType</span><span class="token punctuation">(</span><span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    left<span class="token operator">:</span> <span class="token punctuation">{</span>
      validate<span class="token operator">:</span> <span class="token function">assertNodeType</span><span class="token punctuation">(</span><span class="token string">&quot;Expression&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    right<span class="token operator">:</span> <span class="token punctuation">{</span>
      validate<span class="token operator">:</span> <span class="token function">assertNodeType</span><span class="token punctuation">(</span><span class="token string">&quot;Expression&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  visitor<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;left&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  aliases<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Binary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Expression&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="builders-构建器"><a href="#builders-构建器" class="header-anchor">#</a> <a id="toc-builders"></a>Builders（构建器）</h3> <p>你会注意到上面的 <code>BinaryExpression</code> 定义有一个 <code>builder</code> 字段。.</p> <div class="language-js extra-class"><pre class="language-js"><code>builder<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;operator&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;left&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p>这是由于每一个节点类型都有构造器方法builder，按类似下面的方式使用：</p> <div class="language-js extra-class"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">binaryExpression</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以创建如下所示的 AST：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;BinaryExpression&quot;</span><span class="token punctuation">,</span>
  operator<span class="token operator">:</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span>
  left<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;a&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  right<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;b&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当打印出来之后是这样的：</p> <div class="language-js extra-class"><pre class="language-js"><code>a <span class="token operator">*</span> b
</code></pre></div><p>构造器还会验证自身创建的节点，并在错误使用的情形下会抛出描述性错误，这就引出了下一个方法类型。</p> <h3 id="validators-验证器"><a href="#validators-验证器" class="header-anchor">#</a> <a id="toc-validators"></a>Validators（验证器）</h3> <p><code>BinaryExpression</code> 的定义还包含了节点的字段 <code>fields</code> 信息，以及如何验证这些字段。</p> <div class="language-js extra-class"><pre class="language-js"><code>fields<span class="token operator">:</span> <span class="token punctuation">{</span>
  operator<span class="token operator">:</span> <span class="token punctuation">{</span>
    validate<span class="token operator">:</span> <span class="token function">assertValueType</span><span class="token punctuation">(</span><span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  left<span class="token operator">:</span> <span class="token punctuation">{</span>
    validate<span class="token operator">:</span> <span class="token function">assertNodeType</span><span class="token punctuation">(</span><span class="token string">&quot;Expression&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  right<span class="token operator">:</span> <span class="token punctuation">{</span>
    validate<span class="token operator">:</span> <span class="token function">assertNodeType</span><span class="token punctuation">(</span><span class="token string">&quot;Expression&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以创建两种验证方法。第一种是 <code>isX</code>。.</p> <div class="language-js extra-class"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">isBinaryExpression</span><span class="token punctuation">(</span>maybeBinaryExpressionNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个测试用来确保节点是一个二进制表达式，另外你也可以传入第二个参数来确保节点包含特定的属性和值。</p> <div class="language-js extra-class"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">isBinaryExpression</span><span class="token punctuation">(</span>maybeBinaryExpressionNode<span class="token punctuation">,</span> <span class="token punctuation">{</span> operator<span class="token operator">:</span> <span class="token string">&quot;*&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这些方法还有一种断言式的版本，会抛出异常而不是返回 <code>true</code> 或 <code>false</code>。.</p> <div class="language-js extra-class"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">assertBinaryExpression</span><span class="token punctuation">(</span>maybeBinaryExpressionNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
t<span class="token punctuation">.</span><span class="token function">assertBinaryExpression</span><span class="token punctuation">(</span>maybeBinaryExpressionNode<span class="token punctuation">,</span> <span class="token punctuation">{</span> operator<span class="token operator">:</span> <span class="token string">&quot;*&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Error: Expected type &quot;BinaryExpression&quot; with option { &quot;operator&quot;: &quot;*&quot; }</span>
</code></pre></div><h3 id="converters-变换器"><a href="#converters-变换器" class="header-anchor">#</a> <a id="toc-converters"></a>Converters（变换器）</h3> <blockquote><p>[WIP]</p></blockquote> <h2 id="babel-generator"><a href="#babel-generator" class="header-anchor">#</a> <a id="toc-babel-generator"></a><a href="https://github.com/babel/babel/tree/master/packages/babel-generator" target="_blank" rel="noopener noreferrer"><code>babel-generator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <p>Babel Generator模块是 Babel 的代码生成器，它读取AST并将其转换为代码和源码映射（sourcemaps）。</p> <p>运行以下命令来安装它：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">npm</span> <span class="token function">install</span> --save babel-generator
</code></pre></div><p>然后按如下方式使用：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> babylon <span class="token keyword">from</span> <span class="token string">&quot;babylon&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> generate <span class="token keyword">from</span> <span class="token string">&quot;babel-generator&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function square(n) {
  return n * n;
}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ast <span class="token operator">=</span> babylon<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">//   code: &quot;...&quot;,</span>
<span class="token comment">//   map: &quot;...&quot;</span>
<span class="token comment">// }</span>
</code></pre></div><p>你也可以给 <code>generate()</code> 方法传递选项。.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  retainLines<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  compact<span class="token operator">:</span> <span class="token string">&quot;auto&quot;</span><span class="token punctuation">,</span>
  concise<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  quotes<span class="token operator">:</span> <span class="token string">&quot;double&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="babel-template"><a href="#babel-template" class="header-anchor">#</a> <a id="toc-babel-template"></a><a href="https://github.com/babel/babel/tree/master/packages/babel-template" target="_blank" rel="noopener noreferrer"><code>babel-template</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <p>babel-template 是另一个虽然很小但却非常有用的模块。 它能让你编写字符串形式且带有占位符的代码来代替手动编码， 尤其是生成的大规模 AST的时候。 在计算机科学中，这种能力被称为准引用（quasiquotes）。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">npm</span> <span class="token function">install</span> --save babel-template
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> template <span class="token keyword">from</span> <span class="token string">&quot;babel-template&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> generate <span class="token keyword">from</span> <span class="token string">&quot;babel-generator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> t <span class="token keyword">from</span> <span class="token string">&quot;babel-types&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> buildRequire <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  var IMPORT_NAME = require(SOURCE);
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">buildRequire</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token constant">IMPORT_NAME</span><span class="token operator">:</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&quot;myModule&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">SOURCE</span><span class="token operator">:</span> t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token string">&quot;my-module&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myModule <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;my-module&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="编写你的第一个-babel-插件"><a href="#编写你的第一个-babel-插件" class="header-anchor">#</a> <a id="toc-writing-your-first-babel-plugin"></a>编写你的第一个 Babel 插件</h1> <p>现在你已经熟悉了 Babel 的所有基础知识了，让我们把这些知识和插件的 API融合在一起来编写第一个 Babel 插件吧。</p> <p>先从一个接收了当前<code>babel</code>对象作为参数的 <a href="https://github.com/babel/babel/tree/master/packages/babel-core" target="_blank" rel="noopener noreferrer"><code>function</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 开始。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">babel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// plugin contents</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由于你将会经常这样使用，所以直接取出 <code>babel.types</code> 会更方便：（译注：这是 ES2015 语法中的对象解构，即 Destructuring）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types<span class="token operator">:</span> t <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// plugin contents</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接着返回一个对象，其 <code>visitor</code> 属性是这个插件的主要访问者。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types<span class="token operator">:</span> t <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    visitor<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// visitor contents</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Visitor 中的每个函数接收2个参数：<code>path</code> 和 <code>state</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types<span class="token operator">:</span> t <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    visitor<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">ASTNodeTypeHere</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>让我们快速编写一个可用的插件来展示一下它是如何工作的。下面是我们的源代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>foo <span class="token operator">===</span> bar<span class="token punctuation">;</span>
</code></pre></div><p>其 AST 形式如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;BinaryExpression&quot;</span><span class="token punctuation">,</span>
  operator<span class="token operator">:</span> <span class="token string">&quot;===&quot;</span><span class="token punctuation">,</span>
  left<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  right<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;bar&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们从添加 <code>BinaryExpression</code> 访问者方法开始：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types<span class="token operator">:</span> t <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    visitor<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后我们更确切一些，只关注哪些使用了 <code>===</code> 的 <code>BinaryExpression</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code>visitor<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>operator <span class="token operator">!==</span> <span class="token string">&quot;===&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在我们用新的标识符来替换 <code>left</code> 属性：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>operator <span class="token operator">!==</span> <span class="token string">&quot;===&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&quot;sebmck&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>于是如果我们运行这个插件我们会得到：</p> <div class="language-js extra-class"><pre class="language-js"><code>sebmck <span class="token operator">===</span> bar<span class="token punctuation">;</span>
</code></pre></div><p>现在只需要替换 <code>right</code> 属性了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>operator <span class="token operator">!==</span> <span class="token string">&quot;===&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&quot;sebmck&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>right <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&quot;dork&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这就是我们的最终结果了：</p> <div class="language-js extra-class"><pre class="language-js"><code>sebmck <span class="token operator">===</span> dork<span class="token punctuation">;</span>
</code></pre></div><p>完美！我们的第一个 Babel 插件。</p> <hr> <h1 id="转换操作"><a href="#转换操作" class="header-anchor">#</a> <a id="toc-transformation-operations"></a>转换操作</h1> <h2 id="访问"><a href="#访问" class="header-anchor">#</a> <a id="toc-visiting"></a>访问</h2> <h3 id="获取子节点的path"><a href="#获取子节点的path" class="header-anchor">#</a> <a id="toc-get-the-path-of-a-sub-node"></a>获取子节点的Path</h3> <p>为了得到一个AST节点的属性值，我们一般先访问到该节点，然后利用 <code>path.node.property</code> 方法即可。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// the BinaryExpression AST node has properties: `left`, `right`, `operator`</span>
<span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
  path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
  path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>operator<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果你想访问到该属性内部的<code>path</code>，使用path对象的<code>get</code>方法，传递该属性的字符串形式作为参数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'left'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">Program</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'body.0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="检查节点的类型"><a href="#检查节点的类型" class="header-anchor">#</a> <a id="toc-check-if-a-node-is-a-certain-type"></a>检查节点的类型</h3> <p>如果你想检查节点的类型，最好的方式是：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>你同样可以对节点的属性们做浅层检查：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left<span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>功能上等价于：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
    path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;Identifier&quot;</span> <span class="token operator">&amp;&amp;</span>
    path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;n&quot;</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="检查路径-path-类型"><a href="#检查路径-path-类型" class="header-anchor">#</a> <a id="toc-check-if-a-path-is-a-certain-type"></a>检查路径（Path）类型</h3> <p>一个路径具有相同的方法检查节点的类型：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'left'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>就相当于：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left<span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="检查标识符-identifier-是否被引用"><a href="#检查标识符-identifier-是否被引用" class="header-anchor">#</a> <a id="toc-check-if-an-identifier-is-referenced"></a>检查标识符（Identifier）是否被引用</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">isReferencedIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>或者：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isReferenced</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">,</span> path<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="找到特定的父路径"><a href="#找到特定的父路径" class="header-anchor">#</a> <a id="toc-find-a-specific-parent-path"></a>找到特定的父路径</h3> <p>有时你需要从一个路径向上遍历语法树，直到满足相应的条件。</p> <p>对于每一个父路径调用<code>callback</code>并将其<code>NodePath</code>当作参数，当<code>callback</code>返回真值时，则将其<code>NodePath</code>返回。.</p> <div class="language-js extra-class"><pre class="language-js"><code>path<span class="token punctuation">.</span><span class="token function">findParent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">isObjectExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果也需要遍历当前节点：</p> <div class="language-js extra-class"><pre class="language-js"><code>path<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">isObjectExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>查找最接近的父函数或程序：</p> <div class="language-js extra-class"><pre class="language-js"><code>path<span class="token punctuation">.</span><span class="token function">getFunctionParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>向上遍历语法树，直到找到在列表中的父节点路径</p> <div class="language-js extra-class"><pre class="language-js"><code>path<span class="token punctuation">.</span><span class="token function">getStatementParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="获取同级路径"><a href="#获取同级路径" class="header-anchor">#</a> <a id="toc-get-sibling-paths"></a>获取同级路径</h3> <p>如果一个路径是在一个 <code>Function</code>／<code>Program</code>中的列表里面，它就有同级节点。</p> <ul><li>使用<code>path.inList</code>来判断路径是否有同级节点，</li> <li>使用<code>path.getSibling(index)</code>来获得同级路径,</li> <li>使用 <code>path.key</code>获取路径所在容器的索引,</li> <li>使用 <code>path.container</code>获取路径的容器（包含所有同级节点的数组）</li> <li>使用 <code>path.listKey</code>获取容器的key</li></ul> <blockquote><p>这些API用于 babel-minify &lt;/&gt;中使用的 transform-merge-sibling-variables &lt;/&gt;插件.</p></blockquote><p></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// pathA, path.key = 0</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// pathB, path.key = 1</span>
<span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// pathC, path.key = 2</span>
</code></pre></div> <div class="language- extra-class"><pre class="language-text"><code>
​```js
export default function({ types: t }) {
  return {
    visitor: {
      VariableDeclaration(path) {
        // if the current path is pathA
        path.inList // true
        path.listKey // &quot;body&quot;
        path.key // 0
        path.getSibling(0) // pathA
        path.getSibling(path.key + 1) // pathB
        path.container // [pathA, pathB, pathC]
      }
    }
  };
}
</code></pre></div><h3 id="停止遍历"><a href="#停止遍历" class="header-anchor">#</a> <a id="toc-stopping-traversal"></a>停止遍历</h3> <p>如果你的插件需要在某种情况下不运行，最简单的做法是尽早写回。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>operator <span class="token operator">!==</span> <span class="token string">'**'</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果您在顶级路径中进行子遍历，则可以使用2个提供的API方法：</p> <p><code>path.skip()</code> skips traversing the children of the current path. <code>path.stop()</code> stops traversal entirely.</p> <div class="language-js extra-class"><pre class="language-js"><code>outerPath<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">Function</span><span class="token punctuation">(</span><span class="token parameter">innerPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    innerPath<span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// if checking the children is irrelevant</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">ReferencedIdentifier</span><span class="token punctuation">(</span><span class="token parameter">innerPath<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">.</span>iife <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    innerPath<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// if you want to save some state and then stop traversal, or deopt</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="处理"><a href="#处理" class="header-anchor">#</a> <a id="toc-manipulation"></a>处理</h2> <h3 id="替换一个节点"><a href="#替换一个节点" class="header-anchor">#</a> <a id="toc-replacing-a-node"></a>替换一个节点</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>
    t<span class="token punctuation">.</span><span class="token function">binaryExpression</span><span class="token punctuation">(</span><span class="token string">&quot;**&quot;</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">numberLiteral</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-diff extra-class"><pre class="language-diff"><code><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> function square(n) {
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">   return n * n;
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   return n ** 2;
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span></code></pre></div><h3 id="用多节点替换单节点"><a href="#用多节点替换单节点" class="header-anchor">#</a> <a id="toc-replacing-a-node-with-multiple-nodes"></a>用多节点替换单节点</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">ReturnStatement</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">.</span><span class="token function">replaceWithMultiple</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    t<span class="token punctuation">.</span><span class="token function">expressionStatement</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token string">&quot;Is this the real life?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    t<span class="token punctuation">.</span><span class="token function">expressionStatement</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token string">&quot;Is this just fantasy?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    t<span class="token punctuation">.</span><span class="token function">expressionStatement</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token string">&quot;(Enjoy singing the rest of the song in your head)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-diff extra-class"><pre class="language-diff"><code><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> function square(n) {
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">   return n * n;
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   &quot;Is this the real life?&quot;;
</span><span class="token prefix inserted">+</span><span class="token line">   &quot;Is this just fantasy?&quot;;
</span><span class="token prefix inserted">+</span><span class="token line">   &quot;(Enjoy singing the rest of the song in your head)&quot;;
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span></code></pre></div><blockquote><p>**注意：&lt;/&gt;当用多个节点替换一个表达式时，它们必须是   声明。 这是因为Babel在更换节点时广泛使用启发式算法，这意味着您可以做一些非常疯狂的转换，否则将会非常冗长。</p></blockquote><p></p> <h3 id="用字符串源码替换节点"><a href="#用字符串源码替换节点" class="header-anchor">#</a> <a id="toc-replacing-a-node-with-a-source-string"></a>用字符串源码替换节点</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">.</span><span class="token function">replaceWithSourceString</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function add(a, b) {
    return a + b;
  }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div> <div class="language- extra-class"><pre class="language-text"><code>
​```diff
- function square(n) {
-   return n * n;
+ function add(a, b) {
+   return a + b;
  }
</code></pre></div><blockquote><p>**注意：&lt;/&gt;不建议使用这个API，除非您正在处理动态的源码字符串，否则在访问者外部解析代码更有效率。</p></blockquote><p></p> <h3 id="插入兄弟节点"><a href="#插入兄弟节点" class="header-anchor">#</a> <a id="toc-inserting-a-sibling-node"></a>插入兄弟节点</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">expressionStatement</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token string">&quot;Because I'm easy come, easy go.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  path<span class="token punctuation">.</span><span class="token function">insertAfter</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">expressionStatement</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token string">&quot;A little high, little low.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div> <div class="language- extra-class"><pre class="language-text"><code>
​```diff
+ &quot;Because I'm easy come, easy go.&quot;;
  function square(n) {
    return n * n;
  }
+ &quot;A little high, little low.&quot;;
</code></pre></div><blockquote><p>注意：&lt;/&gt;这里同样应该使用声明或者一个声明数组。 这个使用了在用多个节点替换一个节点&lt;/&gt;中提到的相同的启发式算法。.</p></blockquote><p></p> <h3 id="插入到容器-container-中"><a href="#插入到容器-container-中" class="header-anchor">#</a> <a id="toc-inserting-into-a-container"></a>插入到容器（container）中</h3> <p>如果您想要在AST节点属性中插入一个像<code>body &lt;/ 0&gt;那样的数组。 它与 &lt;code&gt; insertBefore</code>/<code>insertAfter</code> 类似, 但您必须指定 <code>listKey</code> (通常是 <code>正文</code>).</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">ClassMethod</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'body'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unshiftContainer</span><span class="token punctuation">(</span><span class="token string">'body'</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">expressionStatement</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token string">'before'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'body'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pushContainer</span><span class="token punctuation">(</span><span class="token string">'body'</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">expressionStatement</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token string">'after'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div> <div class="language- extra-class"><pre class="language-text"><code>
​```diff
 class A {
  constructor() {
+   &quot;before&quot;
    var a = 'middle';
+   &quot;after&quot;
  }
 }
</code></pre></div><h3 id="删除一个节点"><a href="#删除一个节点" class="header-anchor">#</a> <a id="toc-removing-a-node"></a>删除一个节点</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-diff extra-class"><pre class="language-diff"><code><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> function square(n) {
</span><span class="token prefix deleted">-</span><span class="token line">   return n * n;
</span><span class="token prefix deleted">-</span><span class="token line"> }
</span></span></code></pre></div><h3 id="替换父节点"><a href="#替换父节点" class="header-anchor">#</a> <a id="toc-replacing-a-parent"></a>替换父节点</h3> <p>只需使用parentPath：` path.parentPath &lt;/&gt;调用<code> replaceWith &lt;/&gt;即可</code></p><p></p> <pre><code class="js">BinaryExpression(path) {
  path.parentPath.replaceWith(
    t.expressionStatement(t.stringLiteral(&quot;Anyway the wind blows, doesn't really matter to me, to me.&quot;))
  );
}
`</code></pre> <div class="language-diff extra-class"><pre class="language-diff"><code><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> function square(n) {
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">   return n * n;
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   &quot;Anyway the wind blows, doesn't really matter to me, to me.&quot;;
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span></code></pre></div><h3 id="删除父节点"><a href="#删除父节点" class="header-anchor">#</a> <a id="toc-removing-a-parent"></a>删除父节点</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">.</span>parentPath<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-diff extra-class"><pre class="language-diff"><code><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> function square(n) {
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">   return n * n;
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span></code></pre></div><h2 id="scope-作用域"><a href="#scope-作用域" class="header-anchor">#</a> <a id="toc-scope"></a>Scope（作用域）</h2> <h3 id="检查本地变量是否被绑定"><a href="#检查本地变量是否被绑定" class="header-anchor">#</a> <a id="toc-checking-if-a-local-variable-is-bound"></a>检查本地变量是否被绑定</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">hasBinding</span><span class="token punctuation">(</span><span class="token string">&quot;n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这将遍历范围树并检查特定的绑定。</p> <p>您也可以检查一个作用域是否有**自己的&lt;/&gt;绑定：</p><p></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">hasOwnBinding</span><span class="token punctuation">(</span><span class="token string">&quot;n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="创建一个-uid"><a href="#创建一个-uid" class="header-anchor">#</a> <a id="toc-generating-a-uid"></a>创建一个 UID</h3> <p>这将生成一个标识符，不会与任何本地定义的变量相冲突。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">generateUidIdentifier</span><span class="token punctuation">(</span><span class="token string">&quot;uid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Node { type: &quot;Identifier&quot;, name: &quot;_uid&quot; }</span>
  path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">generateUidIdentifier</span><span class="token punctuation">(</span><span class="token string">&quot;uid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Node { type: &quot;Identifier&quot;, name: &quot;_uid2&quot; }</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="提升变量声明至父级作用域"><a href="#提升变量声明至父级作用域" class="header-anchor">#</a> <a id="toc-pushing-a-variable-declaration-to-a-parent-scope"></a>提升变量声明至父级作用域</h3> <p>有时你可能想要推送一个` VariableDeclaration &lt;/&gt;，这样你就可以分配给它。</p><p></p> <pre><code class="js">FunctionDeclaration(path) {
  const id = path.scope.generateUidIdentifierBasedOnNode(path.node.id);
  path.remove();
  path.scope.parent.push({ id, init: path.node });
}
`</code></pre> <div class="language-diff extra-class"><pre class="language-diff"><code><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> function square(n) {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> var _square = function square(n) {
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   return n * n;
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> }
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> };
</span></span></code></pre></div><h3 id="重命名绑定及其引用"><a href="#重命名绑定及其引用" class="header-anchor">#</a> <a id="toc-rename-a-binding-and-its-references"></a>重命名绑定及其引用</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">&quot;n&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;x&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-diff extra-class"><pre class="language-diff"><code><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> function square(n) {
</span><span class="token prefix deleted">-</span><span class="token line">   return n * n;
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> function square(x) {
</span><span class="token prefix inserted">+</span><span class="token line">   return x * x;
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span></code></pre></div><p>或者，您可以将绑定重命名为生成的唯一标识符：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">&quot;n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-diff extra-class"><pre class="language-diff"><code><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> function square(n) {
</span><span class="token prefix deleted">-</span><span class="token line">   return n * n;
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> function square(_n) {
</span><span class="token prefix inserted">+</span><span class="token line">   return _n * _n;
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span></code></pre></div><hr> <h1 id="插件选项"><a href="#插件选项" class="header-anchor">#</a> <a id="toc-plugin-options"></a>插件选项</h1> <p>如果您想让您的用户自定义您的Babel插件的行为您可以接受用户可以指定的插件特定选项，如下所示：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token string">&quot;my-plugin&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;option1&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string">&quot;option2&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这些选项会通过`状态&lt;/&gt;对象传递给插件访问者：</p><p></p> <pre><code class="js">export default function({ types: t }) {
  return {
    visitor: {
      FunctionDeclaration(path, state) {
        console.log(state.opts);
        // { option1: true, option2: false }
      }
    }
  }
}
`</code></pre> <p>这些选项是特定于插件的，您不能访问其他插件中的选项。</p> <h2 id="插件的准备和收尾工作"><a href="#插件的准备和收尾工作" class="header-anchor">#</a> <a id="toc-pre-and-post-in-plugins"></a> 插件的准备和收尾工作</h2> <p>插件可以具有在插件之前或之后运行的函数。它们可以用于设置或清理/分析目的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types<span class="token operator">:</span> t <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">pre</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    visitor<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">StringLiteral</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="在插件中启用其他语法"><a href="#在插件中启用其他语法" class="header-anchor">#</a> <a id="toc-enabling-syntax-in-plugins"></a> 在插件中启用其他语法</h2> <p>插件可以启用babylon plugins&lt;/&gt;，以便用户不需要安装/启用它们。 这可以防止解析错误，而不会继承语法插件。</p><p></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types<span class="token operator">:</span> t <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    inherits<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;babel-plugin-syntax-jsx&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="抛出一个语法错误"><a href="#抛出一个语法错误" class="header-anchor">#</a> <a id="toc-throwing-a-syntax-error"></a> 抛出一个语法错误</h2> <p>如果您想用babel-code-frame和一个消息抛出一个错误：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types<span class="token operator">:</span> t <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    visitor<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">StringLiteral</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> path<span class="token punctuation">.</span><span class="token function">buildCodeFrameError</span><span class="token punctuation">(</span><span class="token string">&quot;Error message here&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该错误看起来像：</p> <div class="language- extra-class"><pre><code>file.js: Error message here
   7 |
   8 | let tips = [
&gt;  9 |   &quot;Click on any AST node with a '+' to expand it&quot;,
     |   ^
  10 |
  11 |   &quot;Hovering over a node highlights the \
  12 |    corresponding part in the source code&quot;,
</code></pre></div><hr> <h1 id="构建节点"><a href="#构建节点" class="header-anchor">#</a> <a id="toc-building-nodes"></a>构建节点</h1> <p>编写转换时，通常需要构建一些要插入的节点进入AST。 如前所述，您可以使用` babel-types &lt;/&gt;包中的<a href="#builders">builder &lt;/&gt;方法。</a></p><p></p> <p>构建器的方法名称就是您想要的节点类型的名称，除了第一个字母小写。 例如，如果您想建立一个<code> MemberExpression &lt;/&gt;您可以使用<code> t.memberExpression（...）&lt;/&gt;.</code></code></p> <p>这些构建器的参数由节点定义决定。 有一些正在做的工作，以生成易于阅读的文件定义，但现在他们都可以在<a href="https://github.com/babel/babel/tree/master/packages/babel-types/src/definitions">此处</a>找到。.</p> <p>节点定义如下所示：</p> <pre><code class="js">defineType(&quot;MemberExpression&quot;, {
  builder: [&quot;object&quot;, &quot;property&quot;, &quot;computed&quot;],
  visitor: [&quot;object&quot;, &quot;property&quot;],
  aliases: [&quot;Expression&quot;, &quot;LVal&quot;],
  fields: {
    object: {
      validate: assertNodeType(&quot;Expression&quot;)
    },
    property: {
      validate(node, key, val) {
        let expectedType = node.computed ? &quot;Expression&quot; : &quot;Identifier&quot;;
        assertNodeType(expectedType)(node, key, val);
      }
    },
    computed: {
      default: false
    }
  }
});
`</code></pre> <p>在这里你可以看到关于这个特定节点类型的所有信息，包括如何构建它，遍历它，并验证它。</p> <p>通过查看 <code>生成器</code> 属性, 可以看到调用生成器方法所需的3个参数 (<code>t. 情况</code>).</p> <div class="language-js extra-class"><pre class="language-js"><code>生成器<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;property&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;computed&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div><blockquote><p>请注意，有时在节点上可以定制的属性比``构建器&lt;/&gt;数组包含的属性更多。 这是为了防止生成器有太多的参数。 在这些情况下，您需要手动设置属性。 一个例子是<class> ClassMethod &lt;/&gt;.</class></p></blockquote><p></p> <pre><code class="js">// Example
// because the builder doesn't contain `async` as a property
var node = t.classMethod(
  &quot;constructor&quot;,
  t.identifier(&quot;constructor&quot;),
  params,
  body
)
// set it manually after creation
node.async = true;
``</code></pre> <blockquote><p>You can see the validation for the builder arguments with the <code>fields</code> object.</p> <div class="language-js extra-class"><pre class="language-js"><code>fields<span class="token operator">:</span> <span class="token punctuation">{</span>
  object<span class="token operator">:</span> <span class="token punctuation">{</span>
    validate<span class="token operator">:</span> <span class="token function">assertNodeType</span><span class="token punctuation">(</span><span class="token string">&quot;Expression&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  property<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">validate</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> expectedType <span class="token operator">=</span> node<span class="token punctuation">.</span>computed <span class="token operator">?</span> <span class="token string">&quot;Expression&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">;</span>
      <span class="token function">assertNodeType</span><span class="token punctuation">(</span>expectedType<span class="token punctuation">)</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  computed<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></blockquote> <div class="language- extra-class"><pre class="language-text"><code>
You can see that `object` needs to be an `Expression`, `property` either needs to be an `Expression` or an `Identifier` depending on if the member expression is `computed` or not and `computed` is simply a boolean that defaults to `false`.

So we can construct a `MemberExpression` by doing the following:

​```js
t.memberExpression(
  t.identifier('object'),
  t.identifier('property')
  // `computed` is optional
);
</code></pre></div><p>Which will result in:</p> <div class="language-js extra-class"><pre class="language-js"><code>object<span class="token punctuation">.</span>property
</code></pre></div><p>However, we said that <code>object</code> needed to be an <code>Expression</code> so why is <code>Identifier</code> valid?</p> <p>Well if we look at the definition of <code>Identifier</code> we can see that it has an <code>aliases</code> property which states that it is also an expression.</p> <div class="language-js extra-class"><pre class="language-js"><code>aliases<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Expression&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;LVal&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div><p>So since <code>MemberExpression</code> is a type of <code>Expression</code>, we could set it as the <code>object</code> of another <code>MemberExpression</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span>
  t<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span>
    t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'member'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'expression'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span>
  t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'property'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><p>Which will result in:</p> <div class="language-js extra-class"><pre class="language-js"><code>member<span class="token punctuation">.</span>expression<span class="token punctuation">.</span>property
</code></pre></div><p>It's very unlikely that you will ever memorize the builder method signatures for every node type. So you should take some time and understand how they are generated from the node definitions.</p> <p>You can find all of the actual <a href="https://github.com/babel/babel/tree/master/packages/babel-types/src/definitions" target="_blank" rel="noopener noreferrer">definitions here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and you can see them <a href="https://github.com/babel/babel/blob/master/doc/ast/spec.md" target="_blank" rel="noopener noreferrer">documented here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <hr> <h1 id="最佳实践"><a href="#最佳实践" class="header-anchor">#</a> <a id="toc-best-practices"></a>最佳实践</h1> <h2 id="create-helper-builders-and-checkers"><a href="#create-helper-builders-and-checkers" class="header-anchor">#</a> <a id="toc-create-helper-builders-and-checkers"></a> Create Helper Builders and Checkers</h2> <p>It's pretty simple to extract certain checks (if a node is a certain type) into their own helper functions as well as extracting out helpers for specific node types.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">isAssignment</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> node <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>operator <span class="token operator">===</span> opts<span class="token punctuation">.</span>operator <span class="token operator">+</span> <span class="token string">&quot;=&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">buildAssignment</span><span class="token punctuation">(</span><span class="token parameter">left<span class="token punctuation">,</span> right</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">assignmentExpression</span><span class="token punctuation">(</span><span class="token string">&quot;=&quot;</span><span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="尽量避免遍历抽象语法树-ast"><a href="#尽量避免遍历抽象语法树-ast" class="header-anchor">#</a> <a id="toc-avoid-traversing-the-ast-as-much-as-possible"></a>尽量避免遍历抽象语法树（AST）</h2> <p>Traversing the AST is expensive, and it's easy to accidentally traverse the AST more than necessary. This could be thousands if not tens of thousands of extra operations.</p> <p>Babel optimizes this as much as possible, merging visitors together if it can in order to do everything in a single traversal.</p> <h3 id="及时合并访问者对象"><a href="#及时合并访问者对象" class="header-anchor">#</a> <a id="toc-merge-visitors-whenever-possible"></a>及时合并访问者对象</h3> <p>When writing visitors, it may be tempting to call <code>path.traverse</code> in multiple places where they are logically necessary.</p> <div class="language-js extra-class"><pre class="language-js"><code>path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>However, it is far better to write these as a single visitor that only gets run once. Otherwise you are traversing the same tree multiple times for no reason.</p> <div class="language-js extra-class"><pre class="language-js"><code>path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="可以手动查找就不要遍历"><a href="#可以手动查找就不要遍历" class="header-anchor">#</a> <a id="toc-do-not-traverse-when-manual-lookup-will-do"></a>可以手动查找就不要遍历</h3> <p>It may also be tempting to call <code>path.traverse</code> when looking for a particular node type.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> nestedVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'params'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>nestedVisitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>However, if you are looking for something specific and shallow, there is a good chance you can manually lookup the nodes you need without performing a costly traversal.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="优化嵌套的访问者对象"><a href="#优化嵌套的访问者对象" class="header-anchor">#</a> <a id="toc-optimizing-nested-visitors"></a>优化嵌套的访问者对象</h2> <p>当您嵌套访问者（visitor）时，把它们嵌套在您的代码中可能是有意义的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>但是，每当调用`FunctionDeclaration()&lt;/&gt;时都会创建一个新的访问者对象。 That can be costly, because Babel does some processing each time a new
visitor object is passed in (such as exploding keys containing multiple types,
performing validation, and adjusting the object structure). Because Babel stores
flags on visitor objects indicating that it's already performed that processing,
it's better to store the visitor in a variable and pass the same object each
time.</p><p></p> <pre><code class="js">const nestedVisitor = {
  Identifier(path) {
    // ...
  }
};

const MyVisitor = {
  FunctionDeclaration(path) {
    path.traverse(nestedVisitor);
  }
};
`</code></pre> <p>如果您在嵌套的访问者中需要一些状态，像这样：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> exampleState <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>

    path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">===</span> exampleState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>您可以将它作为状态传递给<code>traverse()&lt;/ 0&gt;方法，并有权访问&lt;code&gt;this</code>在访问者中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> nestedVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exampleState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> exampleState <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>nestedVisitor<span class="token punctuation">,</span> <span class="token punctuation">{</span> exampleState <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="留意嵌套结构"><a href="#留意嵌套结构" class="header-anchor">#</a> <a id="toc-being-aware-of-nested-structures"></a>留意嵌套结构</h2> <p>有时候在考虑给定的转换时，可能会忘记给定的转换结构可以是嵌套的。</p> <p>例如，想象一下，我们想要查找<code>构造函数</code> <code>ClassMethod</code> <code>Foo</code> <code>ClassDeclaration</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> constructorVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">ClassMethod</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'constructor'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">ClassDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'Foo'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>constructorVisitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们忽略了类可以嵌套的事实，使用遍历的话，上面我们也会得到一个嵌套的`构造函数&lt;/&gt;：</p><p></p> <pre><code class="js">class Foo {
  constructor() {
    class Bar {
      constructor() {
        // ...
      }
    }
  }
}
`</code></pre> <h2 id="单元测试"><a href="#单元测试" class="header-anchor">#</a> <a id="toc-unit-testing"></a>单元测试</h2> <p>有几种主要的方法来测试babel插件：快照测试，AST测试和执行测试。 对于这个例子，我们将使用 jest &lt;/&gt;，因为它支持盒外快照测试。 我们在这里创建的示例是托管在这个 repo&lt;/&gt;.</p><p></p> <p>首先我们需要一个babel插件，我们将把它放在src / index.js中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>br <span class="token operator">/</span><span class="token operator">&gt;</span>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">testPlugin</span><span class="token punctuation">(</span><span class="token parameter">babel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    visitor<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'foo'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'bar'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="快照测试"><a href="#快照测试" class="header-anchor">#</a> 快照测试</h3> <p>接下来，用`` npm install --save-dev babel-core jest &lt;/&gt;安装我们的依赖关系，
那么我们可以开始写我们的第一个测试：快照。 快照测试允许我们直观地检查我们的babel插件的输出。 我们给它一个输入，告诉它一个快照，并将其保存到一个文件。 我们检查快照到git中。 这允许我们来看看我们什么时候影响了我们任何试用例子测试的输出。 它也给出了使用差异在拉请求的时候。 当然，您可以用任何测试框架来做到这一点，但是要更新一下快照就像<code>jest -u &lt;/&gt;一样简单.</code></p><p></p> <pre><code class="js">// src/__tests__/index-test.js
const babel = require('babel-core');
const plugin = require('../');

var example = `
var foo = 1;
if (foo) console.log(foo);
`;

it('works', () =&gt; {
  const {code} = babel.transform(example, {plugins: [plugin]});
  expect(code).toMatchSnapshot();
});
``</code></pre> <p>这给了我们一个快照文件在`` src / __ tests __ / __ snapshots __ / index-test.js.snap &lt;/&gt;.</p><p></p> <pre><code class="js">exports[`test works 1`] = `
&quot;
var bar = 1;
if (bar) console.log(bar);&quot;
`;
``</code></pre> <p>如果我们在插件中将“bar”更改为“baz”并再次运行，则可以得到以下结果：</p> <div class="language-diff extra-class"><pre class="language-diff"><code>接收到的值与存储的快照1不匹配。

<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   - Snapshot
</span><span class="token prefix unchanged"> </span><span class="token line">   + Received
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   @@ -1,3 +1,3 @@
</span><span class="token prefix unchanged"> </span><span class="token line">    &quot;
</span><span class="token prefix unchanged"> </span><span class="token line">   -var bar = 1;
</span><span class="token prefix unchanged"> </span><span class="token line">   -if (bar) console.log(bar);&quot;
</span><span class="token prefix unchanged"> </span><span class="token line">   +var baz = 1;
</span><span class="token prefix unchanged"> </span><span class="token line">   +if (baz) console.log(baz);&quot;
</span></span></code></pre></div><p>我们看到我们对插件代码的改变如何影响了我们插件的输出 如果输出看起来不错，我们可以运行`jest -u &lt;/&gt;来更新快照。</p><p></p> <h3>AST 测试</h3> <p>除了快照测试外，我们还可以手动检查AST。 这是一个简单但是脆弱的例子。 对于更多涉及的情况，您可能希望利用Babel-遍历。 它允许您用<code>访问者&lt;/&gt;键指定一个对象，就像您使用插件本身。</code></p> <pre><code class="js">it('contains baz', () =&gt; {
  const {ast} = babel.transform(example, {plugins: [plugin]});
  const program = ast.program;
  const declaration = program.body[0].declarations[0];
  assert.equal(declaration.id.name, 'baz');
  // or babelTraverse(program, {visitor: ...})
});
`</code></pre> <h3 id="exec-tests"><a href="#exec-tests" class="header-anchor">#</a> Exec Tests</h3> <p>在这里，我们将转换代码，然后评估它的行为是否正确。 请注意，我们在测试中没有使用``assert&lt;/&gt;。 这确保如果我们的插件做了奇怪的操作，如意外删除断言线，但测试仍然失败。</p><p></p> <pre><code class="js">it('foo is an alias to baz', () =&gt; {
  var input = `
    var foo = 1;
    // test that foo was renamed to baz
    var res = baz;
  `;
  var {code} = babel.transform(input, {plugins: [plugin]});
  var f = new Function(`
    ${code};
    return res;
  `);
  var res = f();
  assert(res === 1, 'res is 1');
});
``</code></pre> <p>Babel核心使用类似的方法&lt;/&gt;去获取快照和执行测试。</p><p></p> <h3 id="babel-plugin-tester"><a href="#babel-plugin-tester" class="header-anchor">#</a> <a href="https://github.com/kentcdodds/babel-plugin-tester" target="_blank" rel="noopener noreferrer"><code>babel-plugin-tester</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <p>这个包使测试插件更容易。 如果您熟悉ESLint的<a href="http://eslint.org/docs/developer-guide/working-with-rules#rule-unit-tests" target="_blank" rel="noopener noreferrer"> RuleTester<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>您应该对这是熟悉的。 您可以看看<a href="https://github.com/kentcdodds/babel-plugin-tester/blob/master/README.md" target="_blank" rel="noopener noreferrer">the docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>去充分了解可能的情况，但这里有一个简单的例子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> pluginTester <span class="token keyword">from</span> <span class="token string">'babel-plugin-tester'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> identifierReversePlugin <span class="token keyword">from</span> <span class="token string">'../identifier-reverse-plugin'</span><span class="token punctuation">;</span>

<span class="token function">pluginTester</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  plugin<span class="token operator">:</span> identifierReversePlugin<span class="token punctuation">,</span>
  fixtures<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'__fixtures__'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  tests<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">'does not change code with no identifiers'</span><span class="token operator">:</span> <span class="token string">'&quot;hello&quot;;'</span><span class="token punctuation">,</span>
    <span class="token string">'changes this code'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      code<span class="token operator">:</span> <span class="token string">'var hello = &quot;hi&quot;;'</span><span class="token punctuation">,</span>
      output<span class="token operator">:</span> <span class="token string">'var olleh = &quot;hi&quot;;'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'using fixtures files'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      fixture<span class="token operator">:</span> <span class="token string">'changed.js'</span><span class="token punctuation">,</span>
      outputFixture<span class="token operator">:</span> <span class="token string">'changed-output.js'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'using jest snapshots'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      code<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        function sayHi(person) {
          return 'Hello ' + person + '!'
        }
      </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      snapshot<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><hr> <blockquote><p>***对于将来的更新，请跟随 @thejameskyle &lt;/&gt;和 @babeljs &lt;/&gt; 的Twitter。</p></blockquote><p></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/9/2021, 6:18:23 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/Zachary/assets/js/app.0753c76b.js" defer></script><script src="/Zachary/assets/js/2.78341334.js" defer></script><script src="/Zachary/assets/js/19.71dc5316.js" defer></script>
  </body>
</html>
